# Based on: https://colbyhub.com/deploy-to-netlify-with-sourcehut/

image: alpine/edge
oauth: pages.sr.ht/PAGES:RW
packages:
  - npm
  - nodejs
secrets:
  - ee56e449-e495-4364-b489-5d93d5c273da
environment:
  site: ihavea.quest
  # https://docs.npmjs.com/cli/v6/using-npm/config#progress
  CI: true
  NETLIFY_SITE_ID: 49076d01-f95d-4e74-9416-a17fe3d91167
tasks:
  - install: |
      cd $site
      npm install
  - package: |
      cd $site
      NODE_ENV=production npm run build
      tar -C _site -cvz . > ../site.tar.gz
  - deploy: |
      cd $site
      {
        set +x
        . ~/.buildsecrets
        set -x
      }
      export NETLIFY_AUTH_TOKEN
      npm run deploy
